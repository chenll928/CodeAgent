# 短期修复实施文档

## 修复概述

针对问题1.md中发现的JSON解析和代码生成失败问题，实施了以下短期修复方案。

## 修复内容

### 1. 改进Prompt设计

#### 1.1 测试代码生成Prompt（_build_test_prompt）

**位置**: `src/intentgraph/agent/code_generator.py:340-385`

**改进内容**:
- 添加了明确的JSON格式要求
- 强调不使用markdown代码块包裹
- 详细说明特殊字符转义规则：
  * `\n` 用于换行
  * `\"` 用于引号
  * `\\` 用于反斜杠
  * `\t` 用于制表符
- 强调docstring必须使用恰好3个引号
- 提供了正确转义的示例

#### 1.2 实现代码生成Prompt（_build_implementation_prompt）

**位置**: `src/intentgraph/agent/code_generator.py:252-301`

**改进内容**:
- 添加了相同的JSON格式要求
- 明确要求所有特殊字符必须转义
- 提供了转义示例

### 2. 增强JSON解析能力

#### 2.1 JSON自动修复功能（_try_repair_json）

**位置**: `src/intentgraph/agent/code_generator.py:708-774`

**新增功能**:
- 修复四引号问题：`""""` → `"""`
- 修复未转义的换行符
- 修复尾随逗号：`,}` → `}`
- 修复缺失的逗号
- 多种修复策略依次尝试

#### 2.2 改进的JSON清理函数（_clean_json_response）

**位置**: `src/intentgraph/agent/code_generator.py:640-707`

**改进内容**:
- 在解析失败时自动调用修复函数
- 对每个潜在的JSON对象都尝试修复
- 更详细的调试日志

### 3. 添加重试机制

#### 3.1 测试生成重试（generate_tests）

**位置**: `src/intentgraph/agent/code_generator.py:202-274`

**新增功能**:
- 最多重试3次
- 每次重试时将上次错误信息添加到prompt中
- 自动尝试修复语法错误
- 最终失败时返回基础模板而不是崩溃

#### 3.2 实现代码生成重试（implement_new_feature）

**位置**: `src/intentgraph/agent/code_generator.py:90-182`

**新增功能**:
- 最多重试3次
- 每次重试时提供错误反馈
- 自动尝试修复语法错误
- 最终失败时返回基础模板

### 4. 语法错误自动修复

#### 4.1 通用语法修复函数（_fix_common_syntax_errors）

**位置**: `src/intentgraph/agent/code_generator.py:894-927`

**修复能力**:
1. **四引号问题**: `""""` → `"""`
2. **未终止的字符串**: 自动补全引号
3. **缺失的冒号**: 在def/class后自动添加
4. **多余的引号**: 清理重复的引号

## 修复效果

### 问题1：JSON解析失败
- **原因**: LLM返回的JSON中代码字段包含未转义的特殊字符
- **修复**: 
  * Prompt明确要求转义
  * 自动修复常见格式错误
  * 多次重试机会

### 问题2：生成的测试代码语法错误
- **原因**: 四引号docstring（`""""`）
- **修复**:
  * Prompt强调使用3个引号
  * 自动检测并修复四引号
  * 编译失败时自动修复并重试

## 工作流程改进

### 修复前流程:
```
LLM生成 → JSON解析失败 → 提取失败 → 占位符代码 → 测试失败 → 整体失败
```

### 修复后流程:
```
LLM生成 → JSON解析
         ↓ 失败
         → 自动修复JSON → 解析成功
                          ↓
                          代码提取 → 语法检查
                                    ↓ 失败
                                    → 自动修复语法 → 成功
                                                    ↓ 仍失败
                                                    → 重试(最多3次)
                                                      ↓ 全部失败
                                                      → 基础模板(不崩溃)
```

## 关键改进点

1. **容错性**: 不会因为单次失败就崩溃
2. **自动修复**: 常见错误自动修复
3. **重试机制**: 给LLM多次机会
4. **降级策略**: 最坏情况返回模板
5. **详细日志**: 便于调试和监控

## 测试建议

1. 使用相同的需求重新测试
2. 观察重试次数和修复效果
3. 检查生成的代码质量
4. 验证错误恢复能力

## 后续优化方向

1. 收集失败案例，改进修复策略
2. 考虑使用更适合代码的响应格式（如base64编码）
3. 添加代码质量检查
4. 实现更智能的错误诊断

